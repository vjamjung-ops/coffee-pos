<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Shop POS Pro Plus - ระบบขายหน้าร้านกาแฟ</title>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
        }
        .scrollbar-hide::-webkit-scrollbar { 
            display: none; 
        }
        .scrollbar-hide { 
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;

        // ==================== SUPABASE DATABASE SERVICE ====================
        const DatabaseService = (() => {
            // !!! สำคัญ: กรุณากรอก Supabase URL และ Anon Key ของคุณที่นี่ !!!
            const SUPABASE_URL = 'https://qgiwhwqtvyxnoyldzttv.supabase.co'; // <--- ใส่ URL ของคุณที่นี่
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnaXdod3F0dnl4bm95bGR6dHR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNzAwNDgsImV4cCI6MjA3Mzk0NjA0OH0.9wvtVPUF1Jl0HyAbgXmL77gFSzQlVencCTx-IGM8D5Y'; // <--- ใส่ Anon Key ของคุณที่นี่

            let supabaseClient;
            try {
                 if (SUPABASE_URL && SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY' && supabase) {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                 } else {
                    console.warn("Supabase credentials not provided or Supabase client not loaded. Application will not connect to a database.");
                 }
            } catch (error) {
                console.error("Supabase initialization failed:", error);
            }

            const createApi = (tableName) => ({
                async getAll(orderBy = 'display_order', ascending = true) {
                    if (!supabaseClient) return [];
                    const { data, error } = await supabaseClient
                        .from(tableName)
                        .select('*')
                        .eq('is_active', true)
                        .order(orderBy, { ascending });
                    if (error) console.error(`Error fetching ${tableName}:`, error);
                    return data || [];
                },
                async add(item) {
                    if (!supabaseClient) return { success: false, error: { message: 'Supabase not configured' } };
                    const { id, ...insertData } = item;
                    const { data, error } = await supabaseClient
                        .from(tableName)
                        .insert([insertData])
                        .select();
                    if (error) return { success: false, error };
                    return { success: true, data: data[0] };
                },
                async update(id, updates) {
                    if (!supabaseClient) return { success: false, error: { message: 'Supabase not configured' } };
                    const { id: _, ...updateData } = updates; // FIX: Exclude id from the update payload
                    const { data, error } = await supabaseClient
                        .from(tableName)
                        .update(updateData)
                        .eq('id', id)
                        .select();
                    if (error) return { success: false, error };
                    return { success: true, data: data[0] };
                },
                async remove(id) { // Soft delete
                    return this.update(id, { is_active: false });
                }
            });

            const categoriesApi = createApi('categories');
            const menuItemsApi = createApi('menu_items');
            const addonsApi = createApi('addons');
            const optionsApi = createApi('options');
            const optionTypesApi = createApi('option_types');

            return {
                getCategories: categoriesApi.getAll,
                addCategory: categoriesApi.add,
                updateCategory: categoriesApi.update,
                deleteCategory: categoriesApi.remove,

                getMenuItems: () => menuItemsApi.getAll('name'),
                addMenuItem: menuItemsApi.add,
                updateMenuItem: menuItemsApi.update,
                deleteMenuItem: menuItemsApi.remove,

                getMenuAddons: () => addonsApi.getAll('name'),
                addAddon: addonsApi.add,
                updateAddon: addonsApi.update,
                deleteAddon: addonsApi.remove,
                
                getOptions: () => optionsApi.getAll('type_key'),
                addOption: optionsApi.add,
                updateOption: optionsApi.update,
                deleteOption: optionsApi.remove,
                
                getOptionTypes: optionTypesApi.getAll,
                addOptionType: optionTypesApi.add,
                updateOptionType: optionTypesApi.update,
                deleteOptionType: optionTypesApi.remove,

                async createOrder(orderData, userId) {
                    if (!supabaseClient) return { success: false, error: { message: 'Supabase not configured' } };
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .insert([{ ...orderData, user_id: userId, order_items: orderData.items }])
                        .select();
                    if (error) return { success: false, error };
                    return { success: true, data: data[0] };
                },
                
                async getOrders(date) {
                    if (!supabaseClient) return [];
                    const startDate = new Date(date);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(date);
                    endDate.setHours(23, 59, 59, 999);

                    const { data, error } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .eq('is_deleted', false)
                        .order('created_at', { ascending: false });
                    if (error) console.error("Error fetching orders:", error);
                    return data || [];
                },

                async updateOrder(orderId, updates) {
                     if (!supabaseClient) return { success: false, error: { message: 'Supabase not configured' } };
                    const { data, error } = await supabaseClient.from('orders').update(updates).eq('id', orderId).select();
                    return error ? { success: false, error } : { success: true, data: data[0] };
                },

                async deleteOrder(orderId) {
                    return this.updateOrder(orderId, { is_deleted: true });
                },

                async getTodaysCashDrawer() {
                    if (!supabaseClient) return null;
                    const today = new Date().toISOString().slice(0, 10);
                    const { data, error } = await supabaseClient
                        .from('cash_drawer')
                        .select('*')
                        .gte('open_time', `${today}T00:00:00.000Z`)
                        .lte('open_time', `${today}T23:59:59.999Z`)
                        .order('open_time', { ascending: false })
                        .limit(1)
                        .single();
                    if (error && error.code !== 'PGRST116') console.error('Error getting cash drawer', error);
                    return data;
                },

                async openCashDrawer(userId, initialAmount) {
                     if (!supabaseClient) return { success: false, error: { message: 'Supabase not configured' } };
                    const existing = await this.getTodaysCashDrawer();
                    if (existing && !existing.is_closed) return { success: false, error: { message: 'ลิ้นชักถูกเปิดแล้ววันนี้' } };

                    const { data, error } = await supabaseClient
                        .from('cash_drawer')
                        .insert([{ opening_amount: initialAmount, user_id: userId }])
                        .select();
                    return error ? { success: false, error } : { success: true, data: data[0] };
                },
                
                async closeCashDrawer(drawerId, closingAmount, userId) {
                    if (!supabaseClient) return { success: false, error: { message: 'Supabase not configured' } };
                    const updates = { 
                        closing_amount: closingAmount, 
                        closing_user_id: userId, 
                        is_closed: true,
                        close_time: new Date().toISOString()
                    };
                    const { data, error } = await supabaseClient.from('cash_drawer').update(updates).eq('id', drawerId).select();
                    return error ? { success: false, error } : { success: true, data: data[0] };
                },

                async getCashDrawerSummary(drawerId) {
                     if (!supabaseClient) return {};
                    const { data: drawerData, error: drawerError } = await supabaseClient.from('cash_drawer').select('*').eq('id', drawerId).single();
                    if (drawerError) return { error: drawerError };

                    const { data, error } = await supabaseClient
                        .from('orders')
                        .select('total')
                        .gte('created_at', drawerData.open_time)
                        .lte('created_at', drawerData.close_time || new Date().toISOString())
                        .eq('paymentMethod', 'cash')
                        .eq('is_deleted', false);
                    
                    if (error) return { error };

                    const cashSales = data.reduce((sum, o) => sum + o.total, 0);
                    return {
                        ...drawerData,
                        cashSales,
                        expectedAmount: (drawerData?.opening_amount || 0) + cashSales
                    };
                },
                
                async getSalesReport(startDate, endDate) {
                     if (!supabaseClient) return { orders: [] };
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .eq('is_deleted', false);
                    if (error) console.error("Error fetching sales report:", error);
                    return { orders: data || [] };
                }
            };
        })();

        const AuthContext = createContext(null);

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState({ id: 1, name: 'Demo Admin', role: 'admin', email: 'admin@coffee.shop' });
            const [loading, setLoading] = useState(false);
            const login = async (email, password) => setUser({ id: 1, name: 'Demo Admin', role: 'admin', email });
            const logout = () => setUser(null);
            return <AuthContext.Provider value={{ user, login, logout, loading }}>{children}</AuthContext.Provider>;
        };

        const useAuth = () => useContext(AuthContext);

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            return (
                <div className={`fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg slide-in z-50`}>
                    <i className={`fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle mr-2`}></i>{message}
                </div>
            );
        };
        
        const OptionsManagement = () => {
            const [options, setOptions] = useState([]);
            const [optionTypes, setOptionTypes] = useState([]);
            const [activeTab, setActiveTab] = useState('options');
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            
            // State for Options
            const [editingOption, setEditingOption] = useState(null);
            const [showAddOptionForm, setShowAddOptionForm] = useState(false);
            const [optionFormData, setOptionFormData] = useState({ type_key: '', name: '', price: 0, display_order: 1 });

            // State for Option Types
            const [editingOptionType, setEditingOptionType] = useState(null);
            const [showAddTypeForm, setShowAddTypeForm] = useState(false);
            const [typeFormData, setTypeFormData] = useState({ name: '', key: '', display_order: 1 });

            useEffect(() => { loadData(); }, []);

            const loadData = async () => {
                setLoading(true);
                const [opts, types] = await Promise.all([DatabaseService.getOptions(), DatabaseService.getOptionTypes()]);
                setOptions(opts);
                setOptionTypes(types);
                if (types.length > 0 && !optionFormData.type_key) {
                    setOptionFormData(prev => ({...prev, type_key: types[0].key}));
                }
                setLoading(false);
            };

            // --- Option Logic ---
            const handleSaveOption = async () => {
                if (!optionFormData.name || !optionFormData.type_key) return setToast({ message: 'กรุณากรอกข้อมูลให้ครบ', type: 'error' });
                const result = editingOption 
                    ? await DatabaseService.updateOption(editingOption.id, optionFormData)
                    : await DatabaseService.addOption(optionFormData);
                if (result.success) {
                    setToast({ message: 'บันทึกสำเร็จ', type: 'success' });
                    await loadData();
                    resetOptionForm();
                } else {
                    setToast({ message: `เกิดข้อผิดพลาด: ${result.error?.message || 'Unknown error'}`, type: 'error' });
                }
            };
            const handleDeleteOption = async (id, name) => {
                if (window.confirm(`ต้องการลบตัวเลือก "${name}" หรือไม่?`)) {
                    if ((await DatabaseService.deleteOption(id)).success) {
                        setToast({ message: 'ลบสำเร็จ', type: 'success' });
                        await loadData();
                    }
                }
            };
            const resetOptionForm = () => {
                setEditingOption(null);
                setShowAddOptionForm(false);
                setOptionFormData({ type_key: optionTypes[0]?.key || '', name: '', price: 0, display_order: 1 });
            };

            // --- Option Type Logic ---
            const handleSaveType = async () => {
                if (!typeFormData.name || !typeFormData.key) return setToast({ message: 'กรุณากรอกข้อมูลให้ครบ', type: 'error' });
                const result = editingOptionType
                    ? await DatabaseService.updateOptionType(editingOptionType.id, typeFormData)
                    : await DatabaseService.addOptionType(typeFormData);
                if (result.success) {
                    setToast({ message: 'บันทึกประเภทสำเร็จ', type: 'success' });
                    await loadData();
                    resetTypeForm();
                } else {
                    setToast({ message: `เกิดข้อผิดพลาด: ${result.error?.message || 'Unknown error'}`, type: 'error' });
                }
            };
            const handleDeleteType = async (id, name) => {
                 if (window.confirm(`การลบประเภท "${name}" จะลบตัวเลือกทั้งหมดที่อยู่ภายใต้ประเภทนี้ด้วย ยืนยันหรือไม่?`)) {
                    if ((await DatabaseService.deleteOptionType(id)).success) {
                        setToast({ message: 'ลบประเภทสำเร็จ', type: 'success' });
                        await loadData();
                    }
                }
            };
             const resetTypeForm = () => {
                setEditingOptionType(null);
                setShowAddTypeForm(false);
                setTypeFormData({ name: '', key: '', display_order: 1 });
            };

            const groupedOptions = options.reduce((acc, option) => {
                (acc[option.type_key] = acc[option.type_key] || []).push(option);
                return acc;
            }, {});

            return (
                <div className="bg-white rounded-lg shadow-lg p-6">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    <h2 className="text-2xl font-bold text-gray-800 mb-6"><i className="fas fa-sliders-h mr-2"></i>จัดการตัวเลือกสินค้า</h2>
                    
                    <div className="flex gap-2 mb-6 border-b">
                        <button onClick={() => setActiveTab('options')} className={`px-4 py-2 font-medium ${activeTab === 'options' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-600'}`}>จัดการตัวเลือก</button>
                        <button onClick={() => setActiveTab('types')} className={`px-4 py-2 font-medium ${activeTab === 'types' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-600'}`}>จัดการประเภทตัวเลือก</button>
                    </div>

                    {activeTab === 'options' && (<div>
                        <div className="flex justify-end mb-4">
                             <button onClick={() => setShowAddOptionForm(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"><i className="fas fa-plus mr-2"></i>เพิ่มตัวเลือก</button>
                        </div>
                        {(showAddOptionForm || editingOption) && (
                            <div className="mb-6 p-4 border-2 border-amber-200 rounded-lg bg-amber-50">
                                <h3 className="font-bold mb-4 text-lg">{editingOption ? 'แก้ไขตัวเลือก' : 'เพิ่มตัวเลือกใหม่'}</h3>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <select value={optionFormData.type_key} onChange={e => setOptionFormData({...optionFormData, type_key: e.target.value})} className="p-2 border rounded-lg">
                                        {optionTypes.map(t => <option key={t.key} value={t.key}>{t.name}</option>)}
                                    </select>
                                    <input type="text" placeholder="ชื่อที่แสดง (เช่น 'หวานน้อย')" value={optionFormData.name} onChange={e => setOptionFormData({...optionFormData, name: e.target.value})} className="p-2 border rounded-lg"/>
                                    <input type="number" placeholder="ราคา ( +/- )" value={optionFormData.price} onChange={e => setOptionFormData({...optionFormData, price: parseFloat(e.target.value) || 0})} className="p-2 border rounded-lg"/>
                                    <input type="number" placeholder="ลำดับ" value={optionFormData.display_order} onChange={e => setOptionFormData({...optionFormData, display_order: parseInt(e.target.value) || 1})} className="p-2 border rounded-lg"/>
                                </div>
                                <div className="flex gap-2 mt-4"><button onClick={handleSaveOption} className="px-4 py-2 bg-blue-600 text-white rounded-lg">บันทึก</button><button onClick={resetOptionForm} className="px-4 py-2 bg-gray-300 rounded-lg">ยกเลิก</button></div>
                            </div>
                        )}
                        {loading ? <p>Loading...</p> : 
                        <div className="space-y-6">
                            {optionTypes.map(type => (
                                <div key={type.key}>
                                    <h3 className="text-lg font-semibold mb-2 border-b pb-1">{type.name}</h3>
                                    {groupedOptions[type.key] ? <table className="w-full">
                                        <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">ชื่อ</th><th className="p-2 text-center">ราคา</th><th className="p-2 text-center">จัดการ</th></tr></thead>
                                        <tbody>
                                            {groupedOptions[type.key].sort((a,b) => a.display_order - b.display_order).map(opt => (
                                                <tr key={opt.id} className="border-b hover:bg-gray-50">
                                                    <td className="p-2 font-medium">{opt.name}</td>
                                                    <td className="p-2 text-center">{opt.price !== 0 ? `${opt.price > 0 ? '+' : ''}${opt.price}` : '-'}</td>
                                                    <td className="p-2 text-center">
                                                        <button onClick={() => { setEditingOption(opt); setOptionFormData(opt); }} className="text-blue-600 mr-3"><i className="fas fa-edit"></i></button>
                                                        <button onClick={() => handleDeleteOption(opt.id, opt.name)} className="text-red-600"><i className="fas fa-trash"></i></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table> : <p className="text-gray-500 text-sm">ยังไม่มีตัวเลือกในประเภทนี้</p>}
                                </div>
                            ))}
                        </div>}
                    </div>)}

                    {activeTab === 'types' && (<div>
                         <div className="flex justify-end mb-4">
                             <button onClick={() => setShowAddTypeForm(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"><i className="fas fa-plus mr-2"></i>เพิ่มประเภท</button>
                        </div>
                        {(showAddTypeForm || editingOptionType) && (
                            <div className="mb-6 p-4 border-2 border-blue-200 rounded-lg bg-blue-50">
                                <h3 className="font-bold mb-4 text-lg">{editingOptionType ? 'แก้ไขประเภท' : 'เพิ่มประเภทใหม่'}</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input type="text" placeholder="ชื่อประเภท (เช่น 'ขนาด')" value={typeFormData.name} onChange={e => setTypeFormData({...typeFormData, name: e.target.value})} className="p-2 border rounded-lg"/>
                                    <input type="text" placeholder="Key (eng, no-space, e.g. 'size')" value={typeFormData.key} onChange={e => setTypeFormData({...typeFormData, key: e.target.value})} className="p-2 border rounded-lg"/>
                                    <input type="number" placeholder="ลำดับ" value={typeFormData.display_order} onChange={e => setTypeFormData({...typeFormData, display_order: parseInt(e.target.value) || 1})} className="p-2 border rounded-lg"/>
                                </div>
                                <div className="flex gap-2 mt-4"><button onClick={handleSaveType} className="px-4 py-2 bg-blue-600 text-white rounded-lg">บันทึก</button><button onClick={resetTypeForm} className="px-4 py-2 bg-gray-300 rounded-lg">ยกเลิก</button></div>
                            </div>
                        )}
                        {loading ? <p>Loading...</p> : <table className="w-full">
                            <thead><tr className="border-b bg-gray-50"><th className="p-2 text-left">ชื่อประเภท</th><th className="p-2 text-left">Key</th><th className="p-2 text-center">จัดการ</th></tr></thead>
                            <tbody>
                                {optionTypes.map(type => (
                                    <tr key={type.id} className="border-b hover:bg-gray-50">
                                        <td className="p-2 font-medium">{type.name}</td>
                                        <td className="p-2">{type.key}</td>
                                        <td className="p-2 text-center">
                                            <button onClick={() => { setEditingOptionType(type); setTypeFormData(type); }} className="text-blue-600 mr-3"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => handleDeleteType(type.id, type.name)} className="text-red-600"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>}
                    </div>)}
                </div>
            );
        };

        const CategoryManagement = () => {
            const [categories, setCategories] = useState([]);
            const [editingCategory, setEditingCategory] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [formData, setFormData] = useState({ name: '', code: '', icon: '', display_order: 1 });

            useEffect(() => { loadCategories(); }, []);

            const loadCategories = async () => { setLoading(true); setCategories(await DatabaseService.getCategories()); setLoading(false); };

            const handleSave = async () => {
                if (!formData.name || !formData.code) return setToast({ message: 'กรุณากรอกข้อมูลให้ครบ', type: 'error' });
                const result = editingCategory ? await DatabaseService.updateCategory(editingCategory.id, formData) : await DatabaseService.addCategory(formData);
                if (result.success) {
                    setToast({ message: 'บันทึกสำเร็จ', type: 'success' });
                    await loadCategories();
                    resetForm();
                } else {
                    setToast({ message: `เกิดข้อผิดพลาด: ${result.error?.message || 'Unknown error'}`, type: 'error' });
                }
            };

            const handleDelete = async (id, name) => {
                if (window.confirm(`ลบหมวดหมู่ "${name}"?`)) {
                    if ((await DatabaseService.deleteCategory(id)).success) {
                        setToast({ message: 'ลบสำเร็จ', type: 'success' });
                        await loadCategories();
                    }
                }
            };

            const resetForm = () => { setEditingCategory(null); setShowAddForm(false); setFormData({ name: '', code: '', icon: '', display_order: 1 }); };

            return (
                <div className="bg-white rounded-lg shadow-lg p-6">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800"><i className="fas fa-tags mr-2"></i>จัดการหมวดหมู่</h2>
                        <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg"><i className="fas fa-plus mr-2"></i>เพิ่มหมวดหมู่</button>
                    </div>
                    {(showAddForm || editingCategory) && (
                         <div className="mb-6 p-4 border-2 border-amber-200 rounded-lg bg-amber-50">
                            <h3 className="font-bold mb-4 text-lg">{editingCategory ? 'แก้ไขหมวดหมู่' : 'เพิ่มหมวดหมู่ใหม่'}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="text" placeholder="ชื่อ" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="p-2 border rounded-lg"/>
                                <input type="text" placeholder="รหัส (eng)" value={formData.code} onChange={e => setFormData({...formData, code: e.target.value.toLowerCase()})} className="p-2 border rounded-lg"/>
                                <input type="text" placeholder="ไอคอน" value={formData.icon} onChange={e => setFormData({...formData, icon: e.target.value})} className="p-2 border rounded-lg"/>
                                <input type="number" placeholder="ลำดับ" value={formData.display_order} onChange={e => setFormData({...formData, display_order: parseInt(e.target.value) || 1})} className="p-2 border rounded-lg"/>
                            </div>
                            <div className="flex gap-2 mt-4">
                                <button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white rounded-lg">บันทึก</button>
                                <button onClick={resetForm} className="px-4 py-2 bg-gray-300 rounded-lg">ยกเลิก</button>
                            </div>
                        </div>
                    )}
                     {loading ? ( <div className="text-center py-8">Loading...</div> ) : (
                        <table className="w-full">
                            <thead><tr className="border-b bg-gray-50"><th className="text-left p-3">ไอคอน</th><th className="text-left p-3">ชื่อ</th><th className="text-center p-3">จัดการ</th></tr></thead>
                            <tbody>
                                {categories.map(cat => (
                                    <tr key={cat.id} className="border-b hover:bg-gray-50">
                                        <td className="p-3 text-2xl">{cat.icon}</td><td className="p-3 font-medium">{cat.name} ({cat.code})</td>
                                        <td className="p-3 text-center">
                                            <button onClick={() => { setEditingCategory(cat); setFormData(cat); }} className="text-blue-600 mr-3"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => handleDelete(cat.id, cat.name)} className="text-red-600"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            );
        };
        
        const MenuManagement = () => {
            const [menuItems, setMenuItems] = useState([]);
            const [addons, setAddons] = useState([]);
            const [categories, setCategories] = useState([]);
            const [optionTypes, setOptionTypes] = useState([]);
            const [editingItem, setEditingItem] = useState(null);
            const [editingAddon, setEditingAddon] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [showAddonForm, setShowAddonForm] = useState(false);
            const [activeTab, setActiveTab] = useState('menu');
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const initialFormData = { name: '', category: '', price: '', image: '☕', allowed_options: [], allow_addons: true };
            const [formData, setFormData] = useState(initialFormData);
            const initialAddonFormData = { name: '', price: '', category: 'topping' };
            const [addonFormData, setAddonFormData] = useState(initialAddonFormData);

            useEffect(() => { loadData(); }, []);

            const loadData = async () => {
                setLoading(true);
                const [items, addonsList, cats, types] = await Promise.all([ 
                    DatabaseService.getMenuItems(), 
                    DatabaseService.getMenuAddons(), 
                    DatabaseService.getCategories(),
                    DatabaseService.getOptionTypes()
                ]);
                setMenuItems(items); setAddons(addonsList); setCategories(cats); setOptionTypes(types);
                if (cats.length > 0) {
                    initialFormData.category = cats[0].code;
                }
                setFormData(prev => ({...prev, category: cats[0]?.code || ''})); 
                setLoading(false);
            };

            const handleAllowedOptionChange = (key) => {
                const currentOptions = formData.allowed_options || [];
                const newOptions = currentOptions.includes(key)
                    ? currentOptions.filter(opt => opt !== key)
                    : [...currentOptions, key];
                setFormData({...formData, allowed_options: newOptions});
            };

            const handleSaveMenu = async () => {
                if (!formData.name || !formData.price || !formData.category) return setToast({ message: 'กรุณากรอกข้อมูลให้ครบ', type: 'error' });
                const dataToSave = { ...formData, price: parseFloat(formData.price) };
                const result = editingItem 
                    ? await DatabaseService.updateMenuItem(editingItem.id, dataToSave) 
                    : await DatabaseService.addMenuItem(dataToSave);

                if (result.success) { setToast({ message: 'บันทึกสำเร็จ', type: 'success' }); await loadData(); resetMenuForm(); }
                else { setToast({ message: `เกิดข้อผิดพลาด: ${result.error?.message || 'Unknown'}`, type: 'error' }); }
            };
            
            const handleSaveAddon = async () => {
                if (!addonFormData.name || !addonFormData.price) return setToast({ message: 'กรุณากรอกข้อมูลให้ครบ', type: 'error' });
                const result = editingAddon ? await DatabaseService.updateAddon(editingAddon.id, { ...addonFormData, price: parseFloat(addonFormData.price) }) : await DatabaseService.addAddon({ ...addonFormData, price: parseFloat(addonFormData.price) });
                if (result.success) { setToast({ message: 'บันทึกสำเร็จ', type: 'success' }); await loadData(); resetAddonForm(); }
                else { setToast({ message: `เกิดข้อผิดพลาด: ${result.error?.message || 'Unknown'}`, type: 'error' }); }
            };

            const handleDeleteMenu = async (id, name) => { if (window.confirm(`ลบ "${name}"?`)) { await DatabaseService.deleteMenuItem(id); setToast({ message: 'ลบสำเร็จ', type: 'success' }); await loadData(); } };
            const handleDeleteAddon = async (id, name) => { if (window.confirm(`ลบ "${name}"?`)) { await DatabaseService.deleteAddon(id); setToast({ message: 'ลบสำเร็จ', type: 'success' }); await loadData(); } };
            const resetMenuForm = () => { setEditingItem(null); setShowAddForm(false); setFormData({...initialFormData, category: categories[0]?.code || ''}); };
            const resetAddonForm = () => { setEditingAddon(null); setShowAddonForm(false); setAddonFormData(initialAddonFormData); };

            return (
                <div className="bg-white rounded-lg shadow-lg p-6">
                     {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    <div className="mb-6"><h2 className="text-2xl font-bold text-gray-800"><i className="fas fa-coffee mr-2"></i>จัดการเมนู</h2></div>
                    <div className="flex gap-2 mb-6 border-b">
                        <button onClick={() => setActiveTab('menu')} className={`px-4 py-2 font-medium ${activeTab === 'menu' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-600'}`}>เมนูหลัก</button>
                        <button onClick={() => setActiveTab('addons')} className={`px-4 py-2 font-medium ${activeTab === 'addons' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-600'}`}>ท็อปปิ้ง/ไซรัป</button>
                    </div>

                    {activeTab === 'menu' && <div>
                        <div className="flex justify-end mb-4"><button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg"><i className="fas fa-plus mr-2"></i>เพิ่มเมนู</button></div>
                        {(showAddForm || editingItem) && <div className="mb-6 p-4 border-2 border-amber-200 rounded-lg bg-amber-50">
                            <h3 className="font-bold mb-4 text-lg">{editingItem ? 'แก้ไขเมนู' : 'เพิ่มเมนูใหม่'}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" placeholder="ชื่อ" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="p-2 border rounded-lg"/>
                                <select value={formData.category} onChange={e => setFormData({...formData, category: e.target.value, image: categories.find(c => c.code === e.target.value)?.icon || '☕'})} className="p-2 border rounded-lg">
                                    {categories.map(cat => <option key={cat.id} value={cat.code}>{cat.name}</option>)}
                                </select>
                                <input type="number" placeholder="ราคา" value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} className="p-2 border rounded-lg"/>
                                <div className="p-2 border rounded-lg bg-white">
                                    <h4 className="font-medium text-sm mb-2">ตัวเลือกที่อนุญาต:</h4>
                                    <div className="flex items-center gap-4 flex-wrap">
                                        {optionTypes.map(type => (
                                             <label key={type.key}><input type="checkbox" checked={formData.allowed_options?.includes(type.key) || false} onChange={() => handleAllowedOptionChange(type.key)} className="mr-1"/>{type.name}</label>
                                        ))}
                                        <label><input type="checkbox" checked={formData.allow_addons} onChange={e => setFormData({...formData, allow_addons: e.target.checked})} className="mr-1"/>ท็อปปิ้ง</label>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2 mt-4"><button onClick={handleSaveMenu} className="px-4 py-2 bg-blue-600 text-white rounded-lg">บันทึก</button><button onClick={resetMenuForm} className="px-4 py-2 bg-gray-300 rounded-lg">ยกเลิก</button></div>
                        </div>}
                         {loading ? ( <div className="text-center py-8">Loading...</div> ) : <table className="w-full">
                            <thead><tr className="border-b bg-gray-50"><th className="p-3 text-left">ชื่อ</th><th className="p-3 text-right">ราคา</th><th className="p-3 text-center">จัดการ</th></tr></thead>
                            <tbody>{menuItems.map(item => <tr key={item.id} className="border-b hover:bg-gray-50">
                                <td className="p-3 font-medium">{item.image} {item.name}</td>
                                <td className="p-3 text-right font-bold text-amber-600">฿{parseFloat(item.price).toFixed(2)}</td>
                                <td className="p-3 text-center">
                                    <button onClick={() => { setEditingItem(item); setFormData({ ...initialFormData, ...item, price: item.price.toString() }); }} className="text-blue-600 mr-3"><i className="fas fa-edit"></i></button>
                                    <button onClick={() => handleDeleteMenu(item.id, item.name)} className="text-red-600"><i className="fas fa-trash"></i></button>
                                </td>
                            </tr>)}</tbody>
                        </table>}
                    </div>}
                    
                     {activeTab === 'addons' && <div>
                        <div className="flex justify-end mb-4"><button onClick={() => setShowAddonForm(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg"><i className="fas fa-plus mr-2"></i>เพิ่ม</button></div>
                        {(showAddonForm || editingAddon) && <div className="mb-6 p-4 border-2 border-amber-200 rounded-lg bg-amber-50">
                            <h3 className="font-bold mb-4 text-lg">{editingAddon ? 'แก้ไข' : 'เพิ่ม'}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" placeholder="ชื่อ" value={addonFormData.name} onChange={e => setAddonFormData({...addonFormData, name: e.target.value})} className="p-2 border rounded-lg"/>
                                <input type="number" placeholder="ราคา" value={addonFormData.price} onChange={e => setAddonFormData({...addonFormData, price: e.target.value})} className="p-2 border rounded-lg"/>
                                <select value={addonFormData.category} onChange={e => setAddonFormData({...addonFormData, category: e.target.value})} className="p-2 border rounded-lg">
                                    <option value="topping">ท็อปปิ้ง</option><option value="syrup">ไซรัป</option><option value="extra">พิเศษ</option>
                                </select>
                            </div>
                            <div className="flex gap-2 mt-4"><button onClick={handleSaveAddon} className="px-4 py-2 bg-blue-600 text-white rounded-lg">บันทึก</button><button onClick={resetAddonForm} className="px-4 py-2 bg-gray-300 rounded-lg">ยกเลิก</button></div>
                        </div>}
                        {loading ? ( <div className="text-center py-8">Loading...</div> ) : <table className="w-full">
                            <thead><tr><th className="p-3 text-left">ชื่อ</th><th className="p-3 text-right">ราคา</th><th className="p-3 text-center">จัดการ</th></tr></thead>
                            <tbody>{addons.map(addon => <tr key={addon.id} className="border-b hover:bg-gray-50">
                                <td className="p-3 font-medium">{addon.name}</td>
                                <td className="p-3 text-right font-bold text-amber-600">+฿{parseFloat(addon.price).toFixed(2)}</td>
                                <td className="p-3 text-center">
                                    <button onClick={() => { setEditingAddon(addon); setAddonFormData({ ...addon, price: addon.price.toString() }); }} className="text-blue-600 mr-3"><i className="fas fa-edit"></i></button>
                                    <button onClick={() => handleDeleteAddon(addon.id, addon.name)} className="text-red-600"><i className="fas fa-trash"></i></button>
                                </td>
                            </tr>)}</tbody>
                        </table>}
                    </div>}
                </div>
            );
        };
        
        const POSScreen = () => {
            const { user } = useAuth();
            const [menuItems, setMenuItems] = useState([]);
            const [categories, setCategories] = useState([]);
            const [addons, setAddons] = useState([]);
            const [options, setOptions] = useState({});
            const [optionTypes, setOptionTypes] = useState([]);
            const [cart, setCart] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [showPayment, setShowPayment] = useState(false);
            const [paymentMethod, setPaymentMethod] = useState('cash');
            const [receivedAmount, setReceivedAmount] = useState('');
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [selectedItem, setSelectedItem] = useState(null);

            useEffect(() => { loadData(); }, []);

            const loadData = async () => {
                setLoading(true);
                const [items, cats, addonsList, opts, types] = await Promise.all([ 
                    DatabaseService.getMenuItems(), 
                    DatabaseService.getCategories(), 
                    DatabaseService.getMenuAddons(), 
                    DatabaseService.getOptions(),
                    DatabaseService.getOptionTypes()
                ]);
                setMenuItems(items);
                setCategories([{ id: 'all', name: 'ทั้งหมด', icon: '📋', code: 'all' }, ...cats]);
                setAddons(addonsList);
                setOptionTypes(types);
                const groupedOptions = opts.reduce((acc, opt) => {
                    (acc[opt.type_key] = acc[opt.type_key] || []).push(opt);
                    return acc;
                }, {});
                Object.values(groupedOptions).forEach(o => o.sort((a,b) => a.display_order - b.display_order));
                setOptions(groupedOptions);
                setLoading(false);
            };

            const handleItemClick = (item) => {
                let defaultOptions = { selectedAddons: [] };
                item.allowed_options?.forEach(key => {
                    defaultOptions[key] = options[key]?.[0]?.name;
                });
                if (!item.allowed_options || item.allowed_options.length === 0 && !item.allow_addons) {
                    addToCart({ ...item, ...defaultOptions });
                } else {
                    setSelectedItem({ ...item, ...defaultOptions });
                }
            };
            
            const calculateItemPrice = (item) => {
                let price = parseFloat(item.price);
                optionTypes.forEach(type => {
                    if (item[type.key]) {
                        price += options[type.key]?.find(o => o.name === item[type.key])?.price || 0;
                    }
                });
                price += item.selectedAddons?.reduce((sum, addon) => sum + parseFloat(addon.price), 0) || 0;
                return price;
            };

            const addToCart = (itemWithOptions) => {
                const subtotal = calculateItemPrice(itemWithOptions);
                setCart([...cart, { ...itemWithOptions, cartId: Date.now(), quantity: 1, subtotal, addons: itemWithOptions.selectedAddons }]);
                setToast({ message: `เพิ่ม ${itemWithOptions.name} แล้ว`, type: 'success' });
                setSelectedItem(null);
            };

            const updateCartItem = (cartId, updates) => {
                setCart(cart.map(item => item.cartId === cartId ? { ...item, ...updates, subtotal: calculateItemPrice({ ...item, ...updates }) * (updates.quantity || item.quantity) } : item));
            };

            const removeFromCart = (cartId) => setCart(cart.filter(item => item.cartId !== cartId));
            const getTotalPrice = () => cart.reduce((total, item) => total + item.subtotal, 0);

            const handlePayment = async () => {
                if (cart.length === 0) return;
                const total = getTotalPrice();
                const change = paymentMethod === 'cash' ? parseFloat(receivedAmount || 0) - total : 0;
                if (paymentMethod === 'cash' && change < 0) return setToast({ message: 'รับเงินไม่พอ', type: 'error' });
                const result = await DatabaseService.createOrder({ items: cart, total, paymentMethod, receivedAmount: paymentMethod === 'cash' ? parseFloat(receivedAmount) : total, change }, user.id);
                if (result.success) {
                    setToast({ message: `ขายสำเร็จ! ${paymentMethod === 'cash' ? `เงินทอน: ฿${change.toFixed(2)}` : ''}`, type: 'success' });
                    setCart([]); setShowPayment(false); setReceivedAmount(''); setPaymentMethod('cash');
                } else {
                     setToast({ message: `เกิดข้อผิดพลาด: ${result.error?.message || 'Unknown error'}`, type: 'error' });
                }
            };
            
            const CustomizationModal = () => {
                if (!selectedItem) return null;
                const [tempItem, setTempItem] = useState(selectedItem);
                const toggleAddon = (addon) => setTempItem({ ...tempItem, selectedAddons: tempItem.selectedAddons.find(a => a.id === addon.id) ? tempItem.selectedAddons.filter(a => a.id !== addon.id) : [...tempItem.selectedAddons, addon] });
                const totalPrice = calculateItemPrice(tempItem);

                return <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div className="bg-white rounded-xl p-6 max-w-md w-full m-4">
                    <h3 className="text-xl font-bold mb-4">{tempItem.image} {tempItem.name}</h3>
                    
                    {tempItem.allowed_options?.map(key => {
                        const type = optionTypes.find(t => t.key === key);
                        const opts = options[key];
                        if (!type || !opts) return null;
                        return (
                            <div className="mb-4" key={key}>
                                <label className="block text-sm font-medium mb-2">{type.name}</label>
                                <div className="flex flex-wrap gap-2">
                                    {opts.map(opt => <button key={opt.name} onClick={() => setTempItem({...tempItem, [key]: opt.name})} className={`p-2 rounded-lg border-2 ${tempItem[key] === opt.name ? 'border-amber-500 bg-amber-50' : 'border-gray-200'}`}>{opt.name} {opt.price !== 0 && `(${opt.price > 0 ? '+' : ''}${opt.price}฿)`}</button>)}
                                </div>
                            </div>
                        )
                    })}
                    
                    {tempItem.allow_addons && addons.length > 0 && <div className="mb-4"><label className="block text-sm font-medium mb-2">เพิ่มเติม</label><div className="space-y-2">{addons.map(addon => <label key={addon.id} className="flex items-center"><input type="checkbox" checked={tempItem.selectedAddons.some(a => a.id === addon.id)} onChange={() => toggleAddon(addon)} className="mr-3"/>{addon.name} (+{parseFloat(addon.price).toFixed(0)}฿)</label>)}</div></div>}
                    <div className="border-t pt-4 my-4 font-bold flex justify-between"><span>รวม:</span><span>฿{totalPrice.toFixed(2)}</span></div>
                    <div className="grid grid-cols-2 gap-3"><button onClick={() => setSelectedItem(null)} className="py-2 bg-gray-200 rounded-lg">ยกเลิก</button><button onClick={() => addToCart(tempItem)} className="py-2 bg-amber-600 text-white rounded-lg">เพิ่ม</button></div>
                </div></div>;
            };
            
            const getCartItemDescription = (item) => {
                let desc = [];
                optionTypes.forEach(type => {
                    if (item[type.key]) {
                        desc.push(item[type.key]);
                    }
                });
                return desc.join(' | ');
            };

            return <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                {selectedItem && <CustomizationModal />}
                <div className="lg:col-span-2 bg-white rounded-lg shadow-lg p-4">
                    <div className="flex gap-2 mb-4 overflow-x-auto scrollbar-hide">{categories.map(cat => <button key={cat.id} onClick={() => setSelectedCategory(cat.code)} className={`px-4 py-2 rounded-lg whitespace-nowrap ${selectedCategory === cat.code ? 'bg-amber-600 text-white' : 'bg-gray-100'}`}>{cat.icon} {cat.name}</button>)}</div>
                    {loading ? <div className="text-center py-8">Loading...</div> : <div className="grid grid-cols-2 md:grid-cols-4 gap-3 overflow-y-auto" style={{maxHeight: 'calc(100vh - 250px)'}}>{(selectedCategory === 'all' ? menuItems : menuItems.filter(i => i.category === selectedCategory)).map(item => <button key={item.id} onClick={() => handleItemClick(item)} className="border-2 rounded-lg p-4 hover:border-amber-500 text-center"><div className="text-3xl mb-2">{item.image}</div><div className="font-medium text-sm">{item.name}</div><div className="font-bold">฿{parseFloat(item.price).toFixed(2)}</div></button>)}</div>}
                </div>
                <div className="bg-white rounded-lg shadow-lg p-4 flex flex-col">
                    <h3 className="text-xl font-bold mb-4"><i className="fas fa-shopping-cart mr-2"></i>รายการ</h3>
                    <div className="flex-1 overflow-y-auto space-y-2 mb-4">
                        {cart.length === 0 ? <div className="text-center text-gray-400 py-8"><i className="fas fa-coffee text-4xl mb-2"></i><p>ยังไม่มีรายการ</p></div> : cart.map(item => <div key={item.cartId} className="border rounded-lg p-3">
                            <div className="flex justify-between">
                                <div><div className="font-medium">{item.name}</div><div className="text-sm text-gray-500">{getCartItemDescription(item)}</div><div className="text-xs text-amber-600">{item.addons?.map(a => a.name).join(', ')}</div></div>
                                <button onClick={() => removeFromCart(item.cartId)} className="text-red-500"><i className="fas fa-trash"></i></button>
                            </div>
                            <div className="flex items-center justify-between mt-2">
                                <div className="flex items-center gap-2"><button onClick={() => updateCartItem(item.cartId, { quantity: Math.max(1, item.quantity - 1) })} className="w-7 h-7 bg-gray-200 rounded">-</button><span>{item.quantity}</span><button onClick={() => updateCartItem(item.cartId, { quantity: item.quantity + 1 })} className="w-7 h-7 bg-gray-200 rounded">+</button></div>
                                <span className="font-bold">฿{item.subtotal.toFixed(2)}</span>
                            </div>
                        </div>)}
                    </div>
                    <div className="border-t pt-4">
                        <div className="flex justify-between text-xl font-bold mb-4"><span>รวม:</span><span>฿{getTotalPrice().toFixed(2)}</span></div>
                        {!showPayment ? <button onClick={() => setShowPayment(true)} disabled={cart.length === 0} className={`w-full py-3 rounded-lg ${cart.length > 0 ? 'bg-amber-600 text-white' : 'bg-gray-200'}`}>ชำระเงิน</button> : <div className="space-y-3">
                            <div className="grid grid-cols-2 gap-2"><button onClick={() => setPaymentMethod('cash')} className={`py-2 rounded-lg ${paymentMethod === 'cash' ? 'bg-green-600 text-white' : 'bg-gray-200'}`}>เงินสด</button><button onClick={() => setPaymentMethod('qr')} className={`py-2 rounded-lg ${paymentMethod === 'qr' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>QR</button></div>
                            {paymentMethod === 'cash' && <input type="number" placeholder="รับเงิน" value={receivedAmount} onChange={e => setReceivedAmount(e.target.value)} className="w-full p-2 border rounded-lg"/>}
                            {paymentMethod === 'cash' && receivedAmount && <div className="text-center"><span>ทอน: </span><span className="font-bold text-lg text-green-600">฿{Math.max(0, parseFloat(receivedAmount) - getTotalPrice()).toFixed(2)}</span></div>}
                            <div className="grid grid-cols-2 gap-2"><button onClick={() => setShowPayment(false)} className="py-2 bg-gray-300 rounded-lg">ยกเลิก</button><button onClick={handlePayment} className="py-2 bg-green-600 text-white rounded-lg">ยืนยัน</button></div>
                        </div>}
                    </div>
                </div>
            </div>;
        };
        
        const CashDrawerManagement = () => {
            const { user } = useAuth();
            const [drawer, setDrawer] = useState(null);
            const [openAmount, setOpenAmount] = useState('');
            const [closeAmount, setCloseAmount] = useState('');
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [summary, setSummary] = useState(null);

            useEffect(() => { checkDrawer(); }, []);

            const checkDrawer = async () => {
                setLoading(true);
                const currentDrawer = await DatabaseService.getTodaysCashDrawer();
                setDrawer(currentDrawer);
                if (currentDrawer && !currentDrawer.is_closed) {
                    setSummary(await DatabaseService.getCashDrawerSummary(currentDrawer.id));
                }
                setLoading(false);
            };

            const handleOpen = async () => {
                const result = await DatabaseService.openCashDrawer(user.id, parseFloat(openAmount));
                if (result.success) { setToast({ message: 'เปิดลิ้นชักสำเร็จ', type: 'success' }); await checkDrawer(); }
                else { setToast({ message: result.error.message, type: 'error' }); }
            };

            const handleClose = async () => {
                const result = await DatabaseService.closeCashDrawer(drawer.id, parseFloat(closeAmount), user.id);
                if (result.success) { setToast({ message: 'ปิดลิ้นชักสำเร็จ', type: 'success' }); await checkDrawer(); }
            };

            if (loading) return <div className="text-center py-8">Loading...</div>;

            return (
                <div className="bg-white rounded-lg shadow-lg p-6">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    <h2 className="text-2xl font-bold mb-6"><i className="fas fa-cash-register mr-2"></i>จัดการลิ้นชักเงินสด</h2>
                    {!drawer || drawer.is_closed ? (
                        <div className="max-w-md mx-auto p-6 bg-yellow-50 rounded-lg">
                            <h3 className="font-bold mb-4 text-yellow-800"><i className="fas fa-lock mr-2"></i>ลิ้นชักปิดอยู่</h3>
                            <input type="number" value={openAmount} onChange={e => setOpenAmount(e.target.value)} className="w-full p-2 border rounded-lg mb-4" placeholder="เงินเปิดลิ้นชัก"/>
                            <button onClick={handleOpen} className="w-full py-3 bg-green-600 text-white rounded-lg"><i className="fas fa-unlock mr-2"></i>เปิดลิ้นชัก</button>
                        </div>
                    ) : (
                        <div className="p-6 bg-green-50 rounded-lg">
                            <h3 className="font-bold mb-4 text-green-800"><i className="fas fa-unlock-alt mr-2"></i>ลิ้นชักเปิดอยู่</h3>
                            {summary && <div className="mb-6 p-4 bg-white rounded">
                                <h4 className="font-bold mb-2">สรุปยอด</h4>
                                <div className="flex justify-between"><span>เงินเปิด:</span><span>฿{parseFloat(summary.opening_amount).toFixed(2)}</span></div>
                                <div className="flex justify-between"><span>ขายเงินสด:</span><span className="text-green-600">+฿{summary.cashSales.toFixed(2)}</span></div>
                                <div className="border-t mt-2 pt-2 font-bold flex justify-between"><span>ควรมีในลิ้นชัก:</span><span>฿{summary.expectedAmount.toFixed(2)}</span></div>
                            </div>}
                            <input type="number" value={closeAmount} onChange={e => setCloseAmount(e.target.value)} className="w-full p-2 border rounded-lg mb-4" placeholder="นับเงินในลิ้นชัก"/>
                            {closeAmount && summary && <div className="mb-4 p-2 bg-gray-100 rounded text-center font-bold">ผลต่าง: <span className={parseFloat(closeAmount) - summary.expectedAmount >= 0 ? 'text-green-600':'text-red-600'}>฿{(parseFloat(closeAmount) - summary.expectedAmount).toFixed(2)}</span></div>}
                            <button onClick={handleClose} className="w-full py-3 bg-red-600 text-white rounded-lg"><i className="fas fa-lock mr-2"></i>ปิดลิ้นชัก</button>
                        </div>
                    )}
                </div>
            );
        };

        const SalesHistory = () => {
            const [orders, setOrders] = useState([]);
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [loading, setLoading] = useState(true);

            useEffect(() => { loadOrders(); }, [date]);
            const loadOrders = async () => { setLoading(true); setOrders(await DatabaseService.getOrders(date)); setLoading(false); };

            return (
                <div className="bg-white rounded-lg shadow-lg p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold"><i className="fas fa-history mr-2"></i>ประวัติการขาย</h2>
                        <input type="date" value={date} onChange={e => setDate(e.target.value)} className="p-2 border rounded-lg"/>
                    </div>
                    {loading ? <div className="text-center py-8">Loading...</div> : orders.length === 0 ? <p className="text-center text-gray-500">ไม่มีรายการขาย</p> :
                        <div className="space-y-4">{orders.map(order => <div key={order.id} className="border rounded-lg p-4">
                            <div className="flex justify-between font-bold"><span>#{order.id}</span><span>฿{parseFloat(order.total).toFixed(2)}</span></div>
                            <div className="text-sm text-gray-500">{new Date(order.created_at).toLocaleTimeString('th-TH')}</div>
                        </div>)}</div>
                    }
                </div>
            );
        };
        
        const SalesReport = () => {
            const [dateRange, setDateRange] = useState('today');
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const chartRef = useRef(null);

            useEffect(() => { loadReport(); }, [dateRange]);

            const loadReport = async () => {
                setLoading(true);
                const { start, end } = getDateRange();
                const report = await DatabaseService.getSalesReport(start, end);
                if (report.orders) {
                    const processed = processReportData(report.orders);
                    setData(processed);
                    renderChart(processed.dailySales);
                }
                setLoading(false);
            };

            const getDateRange = () => {
                const end = new Date(); const start = new Date();
                if (dateRange === 'week') start.setDate(end.getDate() - 7);
                else if (dateRange === 'month') start.setMonth(end.getMonth() - 1);
                start.setHours(0,0,0,0); end.setHours(23,59,59,999);
                return { start, end };
            };
            
            const processReportData = (orders) => ({
                totalRevenue: orders.reduce((sum, o) => sum + o.total, 0),
                totalOrders: orders.length,
                dailySales: orders.reduce((acc, o) => {
                    const date = new Date(o.created_at).toISOString().split('T')[0];
                    acc[date] = (acc[date] || 0) + o.total;
                    return acc;
                }, {})
            });
            
            const renderChart = (dailySales) => {
                if (chartRef.current) chartRef.current.destroy();
                const ctx = document.getElementById('reportChart')?.getContext('2d');
                if (!ctx) return;
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(dailySales).sort(),
                        datasets: [{ label: 'ยอดขาย', data: Object.values(dailySales), borderColor: '#D97706' }]
                    }
                });
            };

            return (
                <div className="bg-white rounded-lg shadow-lg p-6">
                    <h2 className="text-2xl font-bold mb-4"><i className="fas fa-chart-line mr-2"></i>รายงานยอดขาย</h2>
                    <div className="flex gap-2 mb-6">
                        <button onClick={() => setDateRange('today')} className={`px-4 py-2 rounded ${dateRange==='today'?'bg-amber-600 text-white':''}`}>วันนี้</button>
                        <button onClick={() => setDateRange('week')} className={`px-4 py-2 rounded ${dateRange==='week'?'bg-amber-600 text-white':''}`}>7 วัน</button>
                        <button onClick={() => setDateRange('month')} className={`px-4 py-2 rounded ${dateRange==='month'?'bg-amber-600 text-white':''}`}>เดือนนี้</button>
                    </div>
                    {loading ? <div className="text-center">Loading...</div> : data && <>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="p-4 bg-green-100 rounded-lg">
                                <div className="font-bold">ยอดขายรวม</div><div className="text-2xl">฿{data.totalRevenue.toFixed(2)}</div>
                            </div>
                            <div className="p-4 bg-blue-100 rounded-lg">
                                <div className="font-bold">จำนวนออเดอร์</div><div className="text-2xl">{data.totalOrders}</div>
                            </div>
                        </div>
                        <canvas id="reportChart"></canvas>
                    </>}
                </div>
            );
        };
        
        const App = () => {
            const { user, logout } = useAuth();
            const [currentPage, setCurrentPage] = useState('pos');
            const navigation = [
                { id: 'pos', name: 'หน้าขาย', icon: 'fas fa-cash-register', admin: false },
                { id: 'history', name: 'ประวัติ', icon: 'fas fa-history', admin: false },
                { id: 'report', name: 'รายงาน', icon: 'fas fa-chart-line', admin: true },
                { id: 'menu', name: 'จัดการเมนู', icon: 'fas fa-coffee', admin: true },
                { id: 'categories', name: 'หมวดหมู่', icon: 'fas fa-tags', admin: true },
                { id: 'options', name: 'จัดการตัวเลือก', icon: 'fas fa-sliders-h', admin: true },
                { id: 'drawer', name: 'ลิ้นชัก', icon: 'fas fa-cash-register', admin: true },
            ];

            return (
                <div className="min-h-screen bg-amber-50 flex flex-col">
                    <header className="bg-gradient-to-r from-amber-700 to-amber-600 text-white shadow-lg p-4">
                        <div className="container mx-auto flex justify-between items-center">
                            <h1 className="text-2xl font-bold"><i className="fas fa-mug-hot mr-2"></i>Coffee POS</h1>
                            {user && <div><span className="mr-4">{user.name}</span><button onClick={logout} className="bg-red-600 px-3 py-1 rounded">Logout</button></div>}
                        </div>
                    </header>
                    {user && <>
                        <nav className="bg-white shadow-md sticky top-0 z-10">
                            <div className="container mx-auto flex overflow-x-auto scrollbar-hide">
                                {navigation.filter(n => !n.admin || user.role === 'admin').map(nav => (
                                    <button key={nav.id} onClick={() => setCurrentPage(nav.id)} className={`px-4 py-3 font-medium whitespace-nowrap ${currentPage === nav.id ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-600'}`}>
                                        <i className={`${nav.icon} mr-2`}></i>{nav.name}
                                    </button>
                                ))}
                            </div>
                        </nav>
                        <main className="container mx-auto p-4 flex-grow">
                            {currentPage === 'pos' && <POSScreen />}
                            {currentPage === 'history' && <SalesHistory />}
                            {currentPage === 'report' && <SalesReport />}
                            {currentPage === 'menu' && <MenuManagement />}
                            {currentPage === 'categories' && <CategoryManagement />}
                            {currentPage === 'options' && <OptionsManagement />}
                            {currentPage === 'drawer' && <CashDrawerManagement />}
                        </main>
                    </>}
                    <footer className="bg-gray-800 text-white py-4 text-center text-sm">© 2024 Coffee POS Pro Plus</footer>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AuthProvider><App /></AuthProvider>);
    </script>
</body>
</html>

